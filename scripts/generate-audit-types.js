#!/usr/bin/env node
/**
 * Auto-generates TypeScript type declarations for Prisma audit logging
 *
 * Run this after adding new models to schema.prisma:
 *   node scripts/generate-audit-types.js
 *
 * Or add to package.json:
 *   "postinstall": "node scripts/generate-audit-types.js"
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const SCHEMA_PATH = path.join(__dirname, '../schema.prisma');
const OUTPUT_PATH = path.join(__dirname, '../src/types/prisma-audit.d.ts');

function extractModels(schemaContent) {
  const modelRegex = /model\s+(\w+)\s*{/g;
  const models = [];
  let match;

  while ((match = modelRegex.exec(schemaContent)) !== null) {
    models.push(match[1]);
  }

  return models;
}

function generateTypeDeclarations(models) {
  const header = `/**
 * TypeScript declarations to add __auditUserId to Prisma operation arguments
 *
 * This allows type-safe audit logging without "as any" type casts.
 * __auditUserId is REQUIRED for all operations - use context.user.id.
 *
 * AUTO-GENERATED by scripts/generate-audit-types.js
 * DO NOT EDIT MANUALLY - run: node scripts/generate-audit-types.js
 */

import { Prisma } from '@prisma/client';

declare module '@prisma/client' {`;

  const modelDeclarations = models.map(model => `  // ${model} operations
  interface ${model}CreateArgs {
    __auditUserId: number;
  }
  interface ${model}UpdateArgs {
    __auditUserId: number;
  }
  interface ${model}UpsertArgs {
    __auditUserId: number;
  }`).join('\n\n');

  const footer = `\n}\n`;

  return header + '\n' + modelDeclarations + footer;
}

function main() {
  console.log('üîç Reading schema.prisma...');
  const schemaContent = fs.readFileSync(SCHEMA_PATH, 'utf-8');

  console.log('üìã Extracting models...');
  const models = extractModels(schemaContent);
  console.log(`   Found ${models.length} models: ${models.join(', ')}`);

  console.log('üîß Generating type declarations...');
  const typeDeclarations = generateTypeDeclarations(models);

  console.log(`‚úçÔ∏è  Writing to ${OUTPUT_PATH}...`);
  fs.writeFileSync(OUTPUT_PATH, typeDeclarations);

  console.log('‚úÖ Type declarations generated successfully!');
  console.log(`   Models: ${models.length}`);
  console.log(`   Lines: ${typeDeclarations.split('\n').length}`);
}

main();
